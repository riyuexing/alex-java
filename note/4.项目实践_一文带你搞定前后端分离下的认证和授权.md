# ã€é¡¹ç›®å®è·µã€‘ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/1.png)



>  ä»¥é¡¹ç›®é©±åŠ¨å­¦ä¹ ï¼Œä»¥å®è·µæ£€éªŒçœŸçŸ¥



# å‰è¨€

å…³äºè®¤è¯å’Œæˆæƒï¼ŒRä¹‹å‰å·²ç»å†™äº†ä¸¤ç¯‡æ–‡ç« ï¼š

ğŸ“–[ã€é¡¹ç›®å®è·µã€‘åœ¨ç”¨å®‰å…¨æ¡†æ¶å‰ï¼Œæˆ‘æƒ³å…ˆè®©ä½ æ‰‹æ’¸ä¸€ä¸ªç™»é™†è®¤è¯](http://mp.weixin.qq.com/s?__biz=MzkzMjE3NTA3Mg==&mid=2247484720&idx=1&sn=28e0f9ca266016b542a985d7f07dab6d&chksm=c25e88bff52901a91a693ce9f64954a38951a23614e23e633106943d16fc71f39fd7b0f22e16&scene=21#wechat_redirect)

ğŸ“–[ã€é¡¹ç›®å®è·µã€‘ä¸€æ–‡å¸¦ä½ æå®šé¡µé¢æƒé™ã€æŒ‰é’®æƒé™ä»¥åŠæ•°æ®æƒé™](http://mp.weixin.qq.com/s?__biz=MzkzMjE3NTA3Mg==&mid=2247484828&idx=1&sn=c00da8897cd156a28ffa4393752b2404&chksm=c25e8813f52901056709df3002fc745997021518d9553da9b9778597442d206802e49f6dc092&scene=21#wechat_redirect)

åœ¨è¿™ä¸¤ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨å®‰å…¨æ¡†æ¶å°±æå®šäº†è®¤è¯å’ŒæˆæƒåŠŸèƒ½ï¼Œå¹¶ç†è§£äº†å…¶æ ¸å¿ƒåŸç†ã€‚Råœ¨ä¹‹å‰å°±è¯´è¿‡ï¼Œæ ¸å¿ƒåŸç†æŒæ¡äº†ï¼Œæ— è®ºä»€ä¹ˆå®‰å…¨æ¡†æ¶ä½¿ç”¨èµ·æ¥éƒ½ä¼šéå¸¸å®¹æ˜“ï¼é‚£ä¹ˆæœ¬æ–‡å°±è®²è§£å¦‚ä½•ä½¿ç”¨ä¸»æµçš„å®‰å…¨æ¡†æ¶Spring Securityæ¥å®ç°è®¤è¯å’ŒæˆæƒåŠŸèƒ½ã€‚

å½“ç„¶ï¼Œæœ¬æ–‡å¹¶ä¸åªæ˜¯å¯¹æ¡†æ¶çš„ä½¿ç”¨æ–¹æ³•è¿›è¡Œè®²è§£ï¼Œè¿˜ä¼šå‰–æSpring Securityçš„æºç ï¼Œçœ‹åˆ°æœ€åä½ å°±ä¼šå‘ç°ä½ æŒæ¡äº†ä½¿ç”¨æ–¹æ³•çš„åŒæ—¶ï¼Œè¿˜å¯¹æ¡†æ¶æœ‰äº†æ·±åº¦çš„ç†è§£ï¼å¦‚æœæ²¡æœ‰çœ‹è¿‡å‰ä¸¤ç¯‡æ–‡ç« çš„ï¼Œå¼ºçƒˆå»ºè®®å…ˆçœ‹ä¸€ä¸‹ï¼Œå› ä¸ºå®‰å…¨æ¡†æ¶åªæ˜¯å¸®æˆ‘ä»¬å°è£…äº†ä¸€äº›ä¸œè¥¿ï¼ŒèƒŒåçš„åŸç†æ˜¯ä¸ä¼šå˜çš„ã€‚

æœ¬æ–‡æ‰€æœ‰ä»£ç éƒ½æ”¾åœ¨äº†Githubä¸Šï¼Œå…‹éš†ä¸‹æ¥å³å¯è¿è¡Œï¼š

https://github.com/RudeCrab/rude-java

# æçº²æŒˆé¢†

Webç³»ç»Ÿä¸­ç™»å½•è®¤è¯ï¼ˆAuthenticationï¼‰çš„æ ¸å¿ƒå°±æ˜¯**ã€Œå‡­è¯ã€**æœºåˆ¶ï¼Œæ— è®ºæ˜¯`Session`è¿˜æ˜¯`JWT`ï¼Œéƒ½æ˜¯åœ¨ç”¨æˆ·æˆåŠŸç™»å½•æ—¶è¿”å›ç»™ç”¨æˆ·ä¸€ä¸ªå‡­è¯ï¼Œåç»­ç”¨æˆ·è®¿é—®æ¥å£éœ€æºå¸¦å‡­è¯æ¥æ ‡æ˜è‡ªå·±çš„èº«ä»½ã€‚åç«¯ä¼šå¯¹éœ€è¦è¿›è¡Œè®¤è¯çš„æ¥å£è¿›è¡Œå®‰å…¨åˆ¤æ–­ï¼Œè‹¥å‡­è¯æ²¡é—®é¢˜åˆ™ä»£è¡¨å·²ç™»å½•å°±æ”¾è¡Œæ¥å£ï¼Œè‹¥å‡­è¯æœ‰é—®é¢˜åˆ™ç›´æ¥æ‹’ç»è¯·æ±‚ã€‚è¿™ä¸ªå®‰å…¨åˆ¤æ–­**ã€Œéƒ½æ˜¯æ”¾åœ¨è¿‡æ»¤å™¨é‡Œç»Ÿä¸€å¤„ç†çš„ã€**ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/2.jpg)

ç™»å½•è®¤è¯æ˜¯å¯¹**ã€Œç”¨æˆ·çš„èº«ä»½ã€**è¿›è¡Œç¡®è®¤ï¼Œæƒé™æˆæƒï¼ˆAuthorizationï¼‰æ˜¯å¯¹**ã€Œç”¨æˆ·èƒ½å¦è®¿é—®æŸä¸ªèµ„æºã€**è¿›è¡Œç¡®è®¤ï¼Œæˆæƒå‘ç”Ÿéƒ½è®¤è¯ä¹‹åã€‚è®¤è¯ä¸€æ ·ï¼Œè¿™ç§é€šç”¨é€»è¾‘éƒ½æ˜¯æ”¾åœ¨è¿‡æ»¤å™¨é‡Œè¿›è¡Œçš„ç»Ÿä¸€æ“ä½œï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/3.jpg)

`LoginFilter`å…ˆè¿›è¡Œç™»å½•è®¤è¯åˆ¤æ–­ï¼Œè®¤è¯é€šè¿‡åå†ç”±`AuthFilter`è¿›è¡Œæƒé™æˆæƒåˆ¤æ–­ï¼Œä¸€å±‚ä¸€å±‚æ²¡é—®é¢˜åæ‰ä¼šæ‰§è¡Œæˆ‘ä»¬çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ã€‚

Spring Securityå¯¹Webç³»ç»Ÿçš„æ”¯æŒ**ã€Œå°±æ˜¯åŸºäºè¿™ä¸€ä¸ªä¸ªè¿‡æ»¤å™¨ç»„æˆçš„è¿‡æ»¤å™¨é“¾ã€**ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/4.jpg)

ç”¨æˆ·è¯·æ±‚éƒ½ä¼šç»è¿‡`Servlet`çš„è¿‡æ»¤å™¨é“¾ï¼Œåœ¨ä¹‹å‰ä¸¤ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å°±æ˜¯é€šè¿‡è‡ªå®šä¹‰çš„ä¸¤ä¸ªè¿‡æ»¤å™¨å®ç°äº†è®¤è¯æˆæƒåŠŸèƒ½ï¼è€ŒSpring Securityä¹Ÿæ˜¯åšçš„åŒæ ·çš„äº‹å®Œæˆäº†ä¸€ç³»åˆ—åŠŸèƒ½ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/5.jpg)

åœ¨`Servlet`è¿‡æ»¤å™¨é“¾ä¸­ï¼ŒSpring Securityå‘å…¶æ·»åŠ äº†ä¸€ä¸ª`FilterChainProxy`è¿‡æ»¤å™¨ï¼Œè¿™ä¸ªä»£ç†è¿‡æ»¤å™¨ä¼šåˆ›å»ºä¸€å¥—Spring Securityè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨é“¾ï¼Œç„¶åæ‰§è¡Œä¸€ç³»åˆ—è¿‡æ»¤å™¨ã€‚æˆ‘ä»¬å¯ä»¥å¤§æ¦‚çœ‹ä¸€ä¸‹`FilterChainProxy`çš„å¤§è‡´æºç ï¼š

```java
@Override
public void doFilter(ServletRequest request, ServletResponse response,
                     FilterChain chain) throws IOException, ServletException {
    ...çœç•¥å…¶ä»–ä»£ç 
    
    // è·å–Spring Securityçš„ä¸€å¥—è¿‡æ»¤å™¨
    List<Filter> filters = getFilters(request);
    // å°†è¿™ä¸€å¥—è¿‡æ»¤å™¨ç»„æˆSpring Securityè‡ªå·±çš„è¿‡æ»¤é“¾ï¼Œå¹¶å¼€å§‹æ‰§è¡Œ
    VirtualFilterChain vfc = new VirtualFilterChain(fwRequest, chain, filters);
    vfc.doFilter(request, response);
    
    ...çœç•¥å…¶ä»–ä»£ç 
}
```

æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹Spring Securityé»˜è®¤ä¼šå¯ç”¨å¤šå°‘è¿‡æ»¤å™¨ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/6.jpg)

è¿™é‡Œé¢æˆ‘ä»¬åªéœ€è¦é‡ç‚¹å…³æ³¨ä¸¤ä¸ªè¿‡æ»¤å™¨å³å¯ï¼š`UsernamePasswordAuthenticationFilter `è´Ÿè´£ç™»å½•è®¤è¯ï¼Œ`FilterSecurityInterceptor` è´Ÿè´£æƒé™æˆæƒã€‚

**ã€ŒğŸ’¡Spring Securityçš„æ ¸å¿ƒé€»è¾‘å…¨åœ¨è¿™ä¸€å¥—è¿‡æ»¤å™¨ä¸­ï¼Œè¿‡æ»¤å™¨é‡Œä¼šè°ƒç”¨å„ç§ç»„ä»¶å®ŒæˆåŠŸèƒ½ï¼ŒæŒæ¡äº†è¿™äº›è¿‡æ»¤å™¨å’Œç»„ä»¶ä½ å°±æŒæ¡äº†Spring Securityã€**ï¼è¿™ä¸ªæ¡†æ¶çš„ä½¿ç”¨æ–¹å¼å°±æ˜¯å¯¹è¿™äº›è¿‡æ»¤å™¨å’Œç»„ä»¶è¿›è¡Œæ‰©å±•ã€‚

ä¸€å®šè¦è®°ä½è¿™å¥è¯ï¼Œå¸¦ç€è¿™å¥è¯å»ä½¿ç”¨å’Œç†è§£Spring Securityï¼Œä½ ä¼šåƒç«™åœ¨é«˜å¤„ä¿¯ç°ï¼Œæ•´ä¸ªæ¡†æ¶çš„è„‰ç»œä¸€ç›®äº†ç„¶ã€‚

åˆšæ‰æˆ‘ä»¬æ€»è§ˆäº†ä¸€ä¸‹å…¨å±€ï¼Œç°åœ¨æˆ‘ä»¬å°±å¼€å§‹è¿›è¡Œä»£ç ç¼–å†™äº†ã€‚

è¦ä½¿ç”¨Spring Securityè‚¯å®šæ˜¯è¦å…ˆå¼•å…¥ä¾èµ–åŒ…ï¼ˆWebé¡¹ç›®å…¶ä»–å¿…å¤‡ä¾èµ–æˆ‘åœ¨ä¹‹å‰æ–‡ç« ä¸­å·²è®²è§£ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šé˜è¿°äº†ï¼‰ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

ä¾èµ–åŒ…å¯¼å…¥åï¼ŒSpring Securityå°±é»˜è®¤æä¾›äº†è®¸å¤šåŠŸèƒ½å°†æ•´ä¸ªåº”ç”¨ç»™ä¿æŠ¤äº†èµ·æ¥ï¼š

ğŸ“è¦æ±‚ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æ‰èƒ½ä¸åº”ç”¨ç¨‹åºè¿›è¡Œäº¤äº’

ğŸ“åˆ›å»ºå¥½äº†é»˜è®¤ç™»å½•è¡¨å•

ğŸ“ç”Ÿæˆç”¨æˆ·åä¸º`user`çš„éšæœºå¯†ç å¹¶æ‰“å°åœ¨æ§åˆ¶å°ä¸Š

ğŸ“`CSRF`æ”»å‡»é˜²æŠ¤ã€`Session Fixation`æ”»å‡»é˜²æŠ¤

ğŸ“ç­‰ç­‰ç­‰ç­‰......

åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™äº›**ã€Œé»˜è®¤é…ç½®å¥½çš„åŠŸèƒ½å¾€å¾€ä¸ç¬¦åˆæˆ‘ä»¬çš„å®é™…éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¼šè‡ªå®šä¹‰ä¸€äº›é…ç½®ã€**ã€‚é…ç½®æ–¹å¼å¾ˆç®€å•ï¼Œæ–°å»ºä¸€ä¸ªé…ç½®ç±»å³å¯ï¼š

```java
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
}
```

åœ¨è¯¥ç±»ä¸­é‡å†™`WebSecurityConfigurerAdapter`çš„æ–¹æ³•å°±èƒ½å¯¹Spring Securityè¿›è¡Œè‡ªå®šä¹‰é…ç½®ã€‚

# ç™»å½•è®¤è¯

ä¾èµ–åŒ…å’Œé…ç½®ç±»å‡†å¤‡å¥½åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å®Œæˆçš„ç¬¬ä¸€ä¸ªåŠŸèƒ½é‚£è‡ªç„¶æ˜¯ç™»å½•è®¤è¯ï¼Œæ¯•ç«Ÿç”¨æˆ·è¦ä½¿ç”¨æˆ‘ä»¬ç³»ç»Ÿç¬¬ä¸€æ­¥å°±æ˜¯ç™»å½•ã€‚ä¹‹å‰æ–‡ç« ä»‹ç»äº†`Session`å’Œ`JWT`ä¸¤ç§è®¤è¯æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥ç”¨Spring Securityå®ç°è¿™ä¸¤ç§è®¤è¯ã€‚

## æœ€ç®€å•çš„è®¤è¯æ–¹å¼

ä¸ç®¡å“ªç§è®¤è¯æ–¹å¼å’Œæ¡†æ¶ï¼Œæœ‰äº›æ ¸å¿ƒæ¦‚å¿µæ˜¯ä¸ä¼šå˜çš„ï¼Œè¿™äº›æ ¸å¿ƒæ¦‚å¿µåœ¨å®‰å…¨æ¡†æ¶ä¸­ä¼šä»¥å„ç§ç»„ä»¶æ¥ä½“ç°ï¼Œäº†è§£å„ä¸ªç»„ä»¶çš„åŒæ—¶åŠŸèƒ½ä¹Ÿå°±è·Ÿç€å®ç°äº†åŠŸèƒ½ã€‚

æˆ‘ä»¬ç³»ç»Ÿä¸­ä¼šæœ‰è®¸å¤šç”¨æˆ·ï¼Œç¡®è®¤å½“å‰æ˜¯å“ªä¸ªç”¨æˆ·æ­£åœ¨ä½¿ç”¨æˆ‘ä»¬ç³»ç»Ÿå°±æ˜¯ç™»å½•è®¤è¯çš„æœ€ç»ˆç›®çš„ã€‚è¿™é‡Œæˆ‘ä»¬å°±æå–å‡ºäº†ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š**ã€Œå½“å‰ç™»å½•ç”¨æˆ·/å½“å‰è®¤è¯ç”¨æˆ·ã€**ã€‚æ•´ä¸ªç³»ç»Ÿå®‰å…¨éƒ½æ˜¯å›´ç»•å½“å‰ç™»å½•ç”¨æˆ·å±•å¼€çš„ï¼è¿™ä¸ªä¸éš¾ç†è§£ï¼Œè¦æ˜¯å½“å‰ç™»å½•ç”¨æˆ·éƒ½ä¸èƒ½ç¡®è®¤äº†ï¼Œé‚£Aä¸‹äº†ä¸€ä¸ªè®¢å•ï¼Œä¸‹åˆ°äº†Bçš„è´¦æˆ·ä¸Šè¿™ä¸å°±ä¹±å¥—äº†ã€‚è¿™ä¸€æ¦‚å¿µåœ¨Spring Securityä¸­çš„ä½“ç°å°±æ˜¯ **ã€ŒğŸ’¡`Authentication`ã€**ï¼Œå®ƒå­˜å‚¨äº†è®¤è¯ä¿¡æ¯ï¼Œä»£è¡¨å½“å‰ç™»å½•ç”¨æˆ·ã€‚

æˆ‘ä»¬åœ¨ç¨‹åºä¸­å¦‚ä½•è·å–å¹¶ä½¿ç”¨å®ƒå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦é€šè¿‡ **ã€Œ`ğŸ’¡SecurityContext`ã€** æ¥è·å–`Authentication`ï¼Œçœ‹äº†ä¹‹å‰æ–‡ç« çš„æœ‹å‹å¤§æ¦‚å°±çŒœåˆ°äº†è¿™ä¸ª`SecurityContext`å°±æ˜¯æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼

> è¿™ç§åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ¨ªè·¨è‹¥å¹²æ–¹æ³•è°ƒç”¨ï¼Œéœ€è¦ä¼ é€’çš„å¯¹è±¡ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¹‹ä¸ºä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ã€‚ä¸Šä¸‹æ–‡å¯¹è±¡æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œå¦åˆ™ä½ æ¯ä¸ªæ–¹æ³•éƒ½å¾—é¢å¤–å¢åŠ ä¸€ä¸ªå‚æ•°æ¥æ”¶å¯¹è±¡ï¼Œå®åœ¨å¤ªéº»çƒ¦äº†ã€‚

è¿™ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡åˆ™æ˜¯äº¤ç”± **ã€ŒğŸ’¡`SecurityContextHolder`ã€** è¿›è¡Œç®¡ç†ï¼Œä½ å¯ä»¥åœ¨ç¨‹åº**ã€Œä»»ä½•åœ°æ–¹ã€**ä½¿ç”¨å®ƒï¼š

```java
Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
```

å¯ä»¥çœ‹åˆ°è°ƒç”¨é“¾è·¯æ˜¯è¿™æ ·çš„ï¼š`SecurityContextHolder`ğŸ‘‰`SecurityContext`ğŸ‘‰`Authentication`ã€‚

`SecurityContextHolder`åŸç†éå¸¸ç®€å•ï¼Œå°±æ˜¯å’Œæˆ‘ä»¬ä¹‹å‰å®ç°çš„ä¸Šä¸‹æ–‡å¯¹è±¡ä¸€æ ·ï¼Œä½¿ç”¨`ThreadLocal`æ¥ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­ä¼ é€’åŒä¸€ä¸ªå¯¹è±¡ï¼æºç æˆ‘å°±ä¸è´´äº†ï¼Œå…·ä½“å¯çœ‹ä¹‹å‰æ–‡ç« å†™çš„ä¸Šä¸‹æ–‡å¯¹è±¡å®ç°ã€‚

ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†Spring Securityä¸­ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

ğŸ“`Authentication`ï¼šå­˜å‚¨äº†è®¤è¯ä¿¡æ¯ï¼Œä»£è¡¨å½“å‰ç™»å½•ç”¨æˆ·

ğŸ“`SeucirtyContext`ï¼šä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç”¨æ¥è·å–`Authentication`

ğŸ“`SecurityContextHolder`ï¼šä¸Šä¸‹æ–‡ç®¡ç†å¯¹è±¡ï¼Œç”¨æ¥åœ¨ç¨‹åºä»»ä½•åœ°æ–¹è·å–`SecurityContext`

ä»–ä»¬å…³ç³»å¦‚ä¸‹ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/7.png)

`Authentication`ä¸­é‚£ä¸‰ä¸ªç©æ„å°±æ˜¯è®¤è¯ä¿¡æ¯ï¼š

ğŸ“`Principal`ï¼šç”¨æˆ·ä¿¡æ¯ï¼Œæ²¡æœ‰è®¤è¯æ—¶ä¸€èˆ¬æ˜¯ç”¨æˆ·åï¼Œè®¤è¯åä¸€èˆ¬æ˜¯ç”¨æˆ·å¯¹è±¡

ğŸ“`Credentials`ï¼šç”¨æˆ·å‡­è¯ï¼Œä¸€èˆ¬æ˜¯å¯†ç 

ğŸ“`Authorities`ï¼šç”¨æˆ·æƒé™

ç°åœ¨æˆ‘ä»¬çŸ¥é“å¦‚ä½•è·å–å¹¶ä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·äº†ï¼Œé‚£è¿™ä¸ªç”¨æˆ·æ˜¯æ€ä¹ˆè¿›è¡Œè®¤è¯çš„å‘¢ï¼Ÿæ€»ä¸èƒ½æˆ‘éšä¾¿newä¸€ä¸ªå°±ä»£è¡¨ç”¨æˆ·è®¤è¯å®Œæ¯•äº†å§ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜ç¼ºä¸€ä¸ªç”Ÿæˆ`Authentication`å¯¹è±¡çš„è®¤è¯è¿‡ç¨‹ï¼

è®¤è¯è¿‡ç¨‹å°±æ˜¯ç™»å½•è¿‡ç¨‹ï¼Œä¸ä½¿ç”¨å®‰å…¨æ¡†æ¶æ—¶å’±ä»¬çš„è®¤è¯è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

æŸ¥è¯¢ç”¨æˆ·æ•°æ®ğŸ‘‰åˆ¤æ–­è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®ğŸ‘‰æ­£ç¡®åˆ™å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°ä¸Šä¸‹æ–‡ä¸­ğŸ‘‰ä¸Šä¸‹æ–‡ä¸­æœ‰äº†è¿™ä¸ªå¯¹è±¡åˆ™ä»£è¡¨è¯¥ç”¨æˆ·ç™»å½•äº†

Spring Securityçš„è®¤è¯æµç¨‹ä¹Ÿæ˜¯å¦‚æ­¤ï¼š

```java
Authentication authentication = new UsernamePasswordAuthenticationToken(ç”¨æˆ·å, ç”¨æˆ·å¯†ç , ç”¨æˆ·çš„æƒé™é›†åˆ);
SecurityContextHolder.getContext().setAuthentication(authentication);
```

å’Œä¸ä½¿ç”¨å®‰å…¨æ¡†æ¶ä¸€æ ·ï¼Œå°†è®¤è¯ä¿¡æ¯æ”¾åˆ°ä¸Šä¸‹æ–‡ä¸­å°±ä»£è¡¨ç”¨æˆ·å·²ç™»å½•ã€‚ä¸Šé¢ä»£ç æ¼”ç¤ºçš„å°±æ˜¯Spring Securityæœ€ç®€å•çš„è®¤è¯æ–¹å¼ï¼Œç›´æ¥å°†`Authentication`æ”¾ç½®åˆ°`SecurityContext`ä¸­å°±å®Œæˆè®¤è¯äº†ï¼

è¿™ä¸ªæµç¨‹å’Œä¹‹å‰è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„æµç¨‹è‡ªç„¶æ˜¯ç›¸åçš„ï¼š`Authentication`ğŸ‘‰`SecurityContext`ğŸ‘‰`SecurityContextHolder`ã€‚

æ˜¯ä¸æ˜¯è§‰å¾—ï¼Œå°±è¿™ï¼Ÿè¿™å°±å®Œæˆè®¤è¯å•¦ï¼Ÿè¿™ä¹Ÿå¤ªç®€å•äº†å§ã€‚å¯¹äºSpring Securityæ¥è¯´ï¼Œè¿™æ ·ç¡®å®å°±å®Œæˆäº†è®¤è¯ï¼Œä½†å¯¹äºæˆ‘ä»¬æ¥è¯´è¿˜å°‘äº†ä¸€æ­¥ï¼Œé‚£å°±æ˜¯åˆ¤æ–­ç”¨æˆ·çš„è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®ã€‚ç”¨æˆ·è¿›è¡Œç™»å½•æ“ä½œæ—¶ä¼šä¼ é€’è¿‡æ¥è´¦å·å¯†ç ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯è¦æŸ¥è¯¢ç”¨æˆ·æ•°æ®ç„¶ååˆ¤æ–­ä¼ é€’è¿‡æ¥çš„è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œåªæœ‰æ­£ç¡®äº†å’±ä»¬æ‰ä¼šå°†è®¤è¯ä¿¡æ¯æ”¾åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ï¼Œä¸æ­£ç¡®å°±ç›´æ¥æç¤ºé”™è¯¯ï¼š

```java
// è°ƒç”¨serviceå±‚æ‰§è¡Œåˆ¤æ–­ä¸šåŠ¡é€»è¾‘
if (!userService.login(ç”¨æˆ·å, ç”¨æˆ·å¯†ç )) {
    return "è´¦å·å¯†ç é”™è¯¯";
}
// è´¦å·å¯†ç æ­£ç¡®äº†æ‰å°†è®¤è¯ä¿¡æ¯æ”¾åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼ˆç”¨æˆ·æƒé™éœ€è¦å†ä»æ•°æ®åº“ä¸­è·å–ï¼Œåé¢å†è¯´ï¼Œè¿™é‡Œçœç•¥ï¼‰
Authentication authentication = new UsernamePasswordAuthenticationToken(ç”¨æˆ·å, ç”¨æˆ·å¯†ç , ç”¨æˆ·çš„æƒé™é›†åˆ);
SecurityContextHolder.getContext().setAuthentication(authentication);
```

è¿™æ ·æ‰ç®—æ˜¯ä¸€ä¸ªå®Œæ•´çš„è®¤è¯è¿‡ç¨‹ï¼Œå’Œä¸ä½¿ç”¨å®‰å…¨æ¡†æ¶æ—¶çš„æµç¨‹æ˜¯ä¸€æ ·çš„å“¦ï¼Œåªæ˜¯ä¸€äº›ç»„ä»¶ä¹‹å‰æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„ã€‚

è¿™é‡ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¹¶æ ¡éªŒè´¦å·å¯†ç æ˜¯å®Œå…¨ç”±æˆ‘ä»¬è‡ªå·±åœ¨ä¸šåŠ¡å±‚ç¼–å†™æ‰€æœ‰é€»è¾‘ï¼Œå…¶å®è¿™ä¸€å—Spring Securityä¹Ÿæœ‰ç»„ä»¶ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼š

##  AuthenticationManagerè®¤è¯æ–¹å¼

**ã€ŒğŸ’¡`AuthenticationManager`ã€** å°±æ˜¯Spring Securityç”¨äºæ‰§è¡Œèº«ä»½éªŒè¯çš„ç»„ä»¶ï¼Œåªéœ€è¦è°ƒç”¨å®ƒçš„`authenticate`æ–¹æ³•å³å¯å®Œæˆè®¤è¯ã€‚Spring Securityé»˜è®¤çš„è®¤è¯æ–¹å¼å°±æ˜¯åœ¨`UsernamePasswordAuthenticationFilter`è¿™ä¸ªè¿‡æ»¤å™¨ä¸­è°ƒç”¨è¿™ä¸ªç»„ä»¶ï¼Œè¯¥è¿‡æ»¤å™¨è´Ÿè´£è®¤è¯é€»è¾‘ã€‚

æˆ‘ä»¬è¦æŒ‰ç…§è‡ªå·±çš„æ–¹å¼ä½¿ç”¨è¿™ä¸ªç»„ä»¶ï¼Œå…ˆåœ¨ä¹‹å‰é…ç½®ç±»é…ç½®ä¸€ä¸‹ï¼š

```java
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Bean
    @Override
    protected AuthenticationManager authenticationManager() throws Exception {
        return super.authenticationManager();
    }
}
```

è¿™é‡Œæˆ‘ä»¬å†™ä¸Šå®Œæ•´çš„ç™»å½•æ¥å£ä»£ç ï¼š

```java
@RestController
@RequestMapping("/API")
public class LoginController {
    @Autowired
    private AuthenticationManager authenticationManager;

    @PostMapping("/login")
    public String login(@RequestBody LoginParam param) {
        // ç”Ÿæˆä¸€ä¸ªåŒ…å«è´¦å·å¯†ç çš„è®¤è¯ä¿¡æ¯
        Authentication token = new UsernamePasswordAuthenticationToken(param.getUsername(), param.getPassword());
        // AuthenticationManageræ ¡éªŒè¿™ä¸ªè®¤è¯ä¿¡æ¯ï¼Œè¿”å›ä¸€ä¸ªå·²è®¤è¯çš„Authentication
        Authentication authentication = authenticationManager.authenticate(token);
        // å°†è¿”å›çš„Authenticationå­˜åˆ°ä¸Šä¸‹æ–‡ä¸­
        SecurityContextHolder.getContext().setAuthentication(authentication);
        return "ç™»å½•æˆåŠŸ";
    }
}
```

> æ³¨æ„ï¼Œè¿™é‡Œæµç¨‹å’Œä¹‹å‰è¯´çš„æµç¨‹æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œåªæ˜¯ç”¨æˆ·èº«ä»½éªŒè¯æ”¹æˆäº†ä½¿ç”¨`AuthenticationManager`æ¥è¿›è¡Œã€‚

`AuthenticationManager`çš„æ ¡éªŒé€»è¾‘éå¸¸ç®€å•ï¼š

æ ¹æ®ç”¨æˆ·åå…ˆæŸ¥è¯¢å‡ºç”¨æˆ·å¯¹è±¡(æ²¡æœ‰æŸ¥åˆ°åˆ™æŠ›å‡ºå¼‚å¸¸)ğŸ‘‰å°†ç”¨æˆ·å¯¹è±¡çš„å¯†ç å’Œä¼ é€’è¿‡æ¥çš„å¯†ç è¿›è¡Œæ ¡éªŒï¼Œå¯†ç ä¸åŒ¹é…åˆ™æŠ›å‡ºå¼‚å¸¸

è¿™ä¸ªé€»è¾‘æ²¡å•¥å¥½è¯´çš„ï¼Œå†ç®€å•ä¸è¿‡äº†ã€‚é‡ç‚¹æ˜¯è¿™é‡Œæ¯ä¸€ä¸ªæ­¥éª¤Spring Securityéƒ½æä¾›äº†ç»„ä»¶ï¼š

ğŸ“æ˜¯è°æ‰§è¡Œ **ã€Œæ ¹æ®ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·å¯¹è±¡ã€** é€»è¾‘çš„å‘¢ï¼Ÿç”¨æˆ·å¯¹è±¡æ•°æ®å¯ä»¥å­˜åœ¨å†…å­˜ä¸­ã€æ–‡ä»¶ä¸­ã€æ•°æ®åº“ä¸­ï¼Œä½ å¾—ç¡®å®šå¥½æ€ä¹ˆæŸ¥æ‰è¡Œã€‚è¿™ä¸€éƒ¨åˆ†å°±æ˜¯äº¤ç”±**ã€ŒğŸ’¡`UserDetialsService`ã€** å¤„ç†ï¼Œè¯¥æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•`loadUserByUsername(String username)`ï¼Œé€šè¿‡ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·å¯¹è±¡ï¼Œé»˜è®¤å®ç°æ˜¯åœ¨å†…å­˜ä¸­æŸ¥è¯¢ã€‚

ğŸ“é‚£æŸ¥è¯¢å‡ºæ¥çš„ **ã€Œç”¨æˆ·å¯¹è±¡ã€** åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ¯ä¸ªç³»ç»Ÿä¸­çš„ç”¨æˆ·å¯¹è±¡æ•°æ®éƒ½ä¸å°½ç›¸åŒï¼Œå’±ä»¬éœ€è¦ç¡®è®¤æˆ‘ä»¬çš„ç”¨æˆ·æ•°æ®æ˜¯å•¥æ ·çš„æ‰è¡Œã€‚Spring Securityä¸­çš„ç”¨æˆ·æ•°æ®åˆ™æ˜¯ç”±**ã€ŒğŸ’¡`UserDetails`ã€** æ¥ä½“ç°ï¼Œè¯¥æ¥å£ä¸­æä¾›äº†è´¦å·ã€å¯†ç ç­‰é€šç”¨å±æ€§ã€‚

ğŸ“**ã€Œå¯¹å¯†ç è¿›è¡Œæ ¡éªŒã€**å¤§å®¶å¯èƒ½ä¼šè§‰å¾—æ¯”è¾ƒç®€å•ï¼Œ`ifã€else`æå®šï¼Œå°±æ²¡å¿…è¦ç”¨ä»€ä¹ˆç»„ä»¶äº†å§ï¼Ÿä½†æ¡†æ¶æ¯•ç«Ÿæ˜¯æ¡†æ¶è€ƒè™‘çš„æ¯”è¾ƒå‘¨å…¨ï¼Œé™¤äº†`ifã€else`å¤–è¿˜è§£å†³äº†å¯†ç åŠ å¯†çš„é—®é¢˜ï¼Œè¿™ä¸ªç»„ä»¶å°±æ˜¯**ã€ŒğŸ’¡`PasswordEncoder`ã€**ï¼Œè´Ÿè´£å¯†ç åŠ å¯†ä¸æ ¡éªŒã€‚

æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹`AuthenticationManager`æ ¡éªŒé€»è¾‘çš„å¤§æ¦‚æºç ï¼š

```java
public Authentication authenticate(Authentication authentication) throws AuthenticationException {
    ...çœç•¥å…¶ä»–ä»£ç 
    
    // ä¼ é€’è¿‡æ¥çš„ç”¨æˆ·å
    String username = authentication.getName();
    // è°ƒç”¨UserDetailServiceçš„æ–¹æ³•ï¼Œé€šè¿‡ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·å¯¹è±¡UserDetailï¼ˆæŸ¥è¯¢ä¸å‡ºæ¥UserDetailServiceåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰
    UserDetails userDetails = this.getUserDetailsService().loadUserByUsername(username);
    String presentedPassword = authentication.getCredentials().toString();
 
    // ä¼ é€’è¿‡æ¥çš„å¯†ç 
    String password = authentication.getCredentials().toString();
    // ä½¿ç”¨å¯†ç è§£æå™¨PasswordEncoderä¼ é€’è¿‡æ¥çš„å¯†ç æ˜¯å¦å’ŒçœŸå®çš„ç”¨æˆ·å¯†ç åŒ¹é…
    if (!passwordEncoder.matches(password, userDetails.getPassword())) {
        // å¯†ç é”™è¯¯åˆ™æŠ›å‡ºå¼‚å¸¸
        throw new BadCredentialsException("é”™è¯¯ä¿¡æ¯...");
    }
    
    // æ³¨æ„å“¦ï¼Œè¿™é‡Œè¿”å›çš„å·²è®¤è¯Authenticationï¼Œæ˜¯å°†æ•´ä¸ªUserDetailsæ”¾è¿›å»å……å½“Principal
    UsernamePasswordAuthenticationToken result = new UsernamePasswordAuthenticationToken(userDetails,
    authentication.getCredentials(), userDetails.getAuthorities());
 return result;
    
    ...çœç•¥å…¶ä»–ä»£ç 
}
```

`UserDetialsService`ğŸ‘‰`UserDetails`ğŸ‘‰`PasswordEncoder`ï¼Œè¿™ä¸‰ä¸ªç»„ä»¶Spring Securityéƒ½æœ‰é»˜è®¤å®ç°ï¼Œè¿™ä¸€èˆ¬æ˜¯æ»¡è¶³ä¸äº†æˆ‘ä»¬çš„å®é™…éœ€æ±‚çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è‡ªå·±æ¥å®ç°è¿™äº›ç»„ä»¶ï¼

### åŠ å¯†å™¨PasswordEncoder

é¦–å…ˆæ˜¯`PasswordEncoder`ï¼Œè¿™ä¸ªæ¥å£å¾ˆç®€å•å°±ä¸¤ä¸ªé‡è¦æ–¹æ³•ï¼š

```java
public interface PasswordEncoder {
    /**
   * åŠ å¯†
   */
    String encode(CharSequence rawPassword);
    /**
   * å°†æœªåŠ å¯†çš„å­—ç¬¦ä¸²ï¼ˆå‰ç«¯ä¼ é€’è¿‡æ¥çš„å¯†ç ï¼‰å’Œå·²åŠ å¯†çš„å­—ç¬¦ä¸²ï¼ˆæ•°æ®åº“ä¸­å­˜å‚¨çš„å¯†ç ï¼‰è¿›è¡Œæ ¡éªŒ
   */
    boolean matches(CharSequence rawPassword, String encodedPassword);
}
```

ä½ å¯ä»¥å®ç°æ­¤æ¥å£å®šä¹‰è‡ªå·±çš„åŠ å¯†è§„åˆ™å’Œæ ¡éªŒè§„åˆ™ï¼Œä¸è¿‡Spring Securityæä¾›äº†å¾ˆå¤šåŠ å¯†å™¨å®ç°ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰å®šä¸€ä¸ªå°±å¥½ã€‚å¯ä»¥åœ¨ä¹‹å‰æ‰€è¯´çš„**ã€Œé…ç½®ç±»ã€**é‡Œè¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š

```java
@Bean
public PasswordEncoder(){
    // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨bcryptåŠ å¯†ç®—æ³•ï¼Œå®‰å…¨æ€§æ¯”è¾ƒé«˜
    return new BCryptPasswordEncoder();
}
```

å› ä¸ºå¯†ç åŠ å¯†æ˜¯æˆ‘å‰é¢æ–‡ç« å°‘æ•°æ²¡æœ‰ä»‹ç»çš„åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™é‡Œé¢å¤–æä¸€å˜´ã€‚å¾€æ•°æ®åº“ä¸­æ·»åŠ ç”¨æˆ·æ•°æ®æ—¶å°±è¦å°†å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå¦åˆ™åç»­è¿›è¡Œå¯†ç æ ¡éªŒæ—¶ä»æ•°æ®åº“æ‹¿å‡ºæ¥çš„è¿˜æ˜¯æ˜æ–‡å¯†ç ï¼Œæ˜¯æ— æ³•é€šè¿‡æ ¡éªŒçš„ã€‚æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨æˆ·æ³¨å†Œçš„æ¥å£ï¼š

```java
@Autowired
private PasswordEncoder passwordEncoder;

@PostMapping("/register")
public String register(@RequestBody UserParam param) {
    UserEntity user = new UserEntity();
    // è°ƒç”¨åŠ å¯†å™¨å°†å‰ç«¯ä¼ é€’è¿‡æ¥çš„å¯†ç è¿›è¡ŒåŠ å¯†
    user.setUsername(param.getUsername()).setPassword(passwordEncoder.encode(param.getPassword()));
    // å°†ç”¨æˆ·å®ä½“å¯¹è±¡æ·»åŠ åˆ°æ•°æ®åº“
    userService.save(user);
    return "æ³¨å†ŒæˆåŠŸ";
}
```

è¿™æ ·æ•°æ®åº“ä¸­å­˜å‚¨çš„å¯†ç éƒ½æ˜¯å·²åŠ å¯†çš„äº†ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/7.jpg)

###  ç”¨æˆ·å¯¹è±¡UserDetails

è¯¥æ¥å£å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç”¨æˆ·å¯¹è±¡ï¼Œå®ƒæä¾›äº†ç”¨æˆ·çš„ä¸€äº›é€šç”¨å±æ€§ï¼š

```java
public interface UserDetails extends Serializable {
   /**
    * ç”¨æˆ·æƒé™é›†åˆï¼ˆè¿™ä¸ªæƒé™å¯¹è±¡ç°åœ¨ä¸ç®¡å®ƒï¼Œåˆ°æƒé™æ—¶æˆ‘ä¼šè®²è§£ï¼‰
    */
   Collection<? extends GrantedAuthority> getAuthorities();
   /**
    * ç”¨æˆ·å¯†ç 
    */
   String getPassword();
   /**
    * ç”¨æˆ·å
    */
   String getUsername();
   /**
    * ç”¨æˆ·æ²¡è¿‡æœŸè¿”å›trueï¼Œåä¹‹åˆ™false
    */
   boolean isAccountNonExpired();
   /**
    * ç”¨æˆ·æ²¡é”å®šè¿”å›trueï¼Œåä¹‹åˆ™false
    */
   boolean isAccountNonLocked();
   /**
    * ç”¨æˆ·å‡­æ®(é€šå¸¸ä¸ºå¯†ç )æ²¡è¿‡æœŸè¿”å›trueï¼Œåä¹‹åˆ™false
    */
   boolean isCredentialsNonExpired();
   /**
    * ç”¨æˆ·æ˜¯å¯ç”¨çŠ¶æ€è¿”å›trueï¼Œåä¹‹åˆ™false
    */
   boolean isEnabled();
}
```

å®é™…å¼€å‘ä¸­æˆ‘ä»¬çš„ç”¨æˆ·å±æ€§å„ç§å„æ ·ï¼Œè¿™äº›é»˜è®¤å±æ€§å¿…ç„¶æ˜¯æ»¡è¶³ä¸äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¼šè‡ªå·±å®ç°è¯¥æ¥å£ï¼Œç„¶åè®¾ç½®å¥½æˆ‘ä»¬å®é™…çš„ç”¨æˆ·å®ä½“å¯¹è±¡ã€‚å®ç°æ­¤æ¥å£è¦é‡å†™å¾ˆå¤šæ–¹æ³•æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿Spring Securityæä¾›çš„`org.springframework.security.core.userdetails.User`ç±»ï¼Œè¯¥ç±»å®ç°äº†`UserDetails`æ¥å£å¸®æˆ‘ä»¬çœå»äº†é‡å†™æ–¹æ³•çš„å·¥ä½œï¼š

```java
public class UserDetail extends User {
    /**
     * æˆ‘ä»¬è‡ªå·±çš„ç”¨æˆ·å®ä½“å¯¹è±¡ï¼Œè¦è°ƒå–ç”¨æˆ·ä¿¡æ¯æ—¶ç›´æ¥è·å–è¿™ä¸ªå®ä½“å¯¹è±¡ã€‚ï¼ˆè¿™é‡Œæˆ‘å°±ä¸å†™get/setæ–¹æ³•äº†ï¼‰
     */
    private UserEntity userEntity;

    public UserDetail(UserEntity userEntity, Collection<? extends GrantedAuthority> authorities) {
        // å¿…é¡»è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼Œä»¥åˆå§‹åŒ–ç”¨æˆ·åã€å¯†ç ã€æƒé™
        super(userEntity.getUsername(), userEntity.getPassword(), authorities);
        this.userEntity = userEntity;
    }
}
```

###  ä¸šåŠ¡å¯¹è±¡UserDetailsService

è¯¥æ¥å£å¾ˆç®€å•åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š

```java
public interface UserDetailsService {
 /**
  * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·å¯¹è±¡ï¼ˆè·å–ä¸åˆ°ç›´æ¥æŠ›å¼‚å¸¸ï¼‰
  */
 UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;
```

å’±ä»¬è‡ªå·±çš„ç”¨æˆ·ä¸šåŠ¡ç±»è¯¥æ¥å£å³å¯å®Œæˆè‡ªå·±çš„é€»è¾‘ï¼š

```java
@Service
public class UserServiceImpl implements UserService, UserDetailsService {
    @Autowired
    private UserMapper userMapper;

    @Override
    public UserDetails loadUserByUsername(String username) {
        // ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºç”¨æˆ·å®ä½“å¯¹è±¡
        UserEntity user = userMapper.selectByUsername(username);
        // è‹¥æ²¡æŸ¥è¯¢åˆ°ä¸€å®šè¦æŠ›å‡ºè¯¥å¼‚å¸¸ï¼Œè¿™æ ·æ‰èƒ½è¢«Spring Securityçš„é”™è¯¯å¤„ç†å™¨å¤„ç†
        if (user == null) {
            throw new UsernameNotFoundException("æ²¡æœ‰æ‰¾åˆ°è¯¥ç”¨æˆ·");
        }
        // èµ°åˆ°è¿™ä»£è¡¨æŸ¥è¯¢åˆ°äº†å®ä½“å¯¹è±¡ï¼Œé‚£å°±è¿”å›æˆ‘ä»¬è‡ªå®šä¹‰çš„UserDetailå¯¹è±¡ï¼ˆè¿™é‡Œæƒé™æš‚æ—¶æ”¾ä¸ªç©ºé›†åˆï¼Œåé¢æˆ‘ä¼šè®²è§£ï¼‰
        return new UserDetail(user, Collections.emptyList());
    }
}
```

`AuthenticationManager`æ ¡éªŒæ‰€è°ƒç”¨çš„ä¸‰ä¸ªç»„ä»¶æˆ‘ä»¬å°±å·²ç»åšå¥½å®ç°äº†ï¼

ä¸çŸ¥é“å¤§å®¶æ³¨æ„åˆ°æ²¡æœ‰ï¼Œå½“æˆ‘ä»¬æŸ¥è¯¢ç”¨æˆ·å¤±è´¥æ—¶æˆ–è€…æ ¡éªŒå¯†ç å¤±è´¥æ—¶éƒ½ä¼šæŠ›å‡ºSpring Securityçš„è‡ªå®šä¹‰å¼‚å¸¸ã€‚è¿™äº›å¼‚å¸¸ä¸å¯èƒ½æ”¾ä»»ä¸ç®¡ï¼ŒSpring Securityå¯¹äºè¿™äº›å¼‚å¸¸éƒ½æ˜¯åœ¨`ExceptionTranslationFilter`è¿‡æ»¤å™¨ä¸­è¿›è¡Œå¤„ç†ï¼ˆå¯ä»¥å›é¡¾ä¸€ä¸‹å‰é¢çš„è¿‡æ»¤å™¨æˆªå›¾ï¼‰ï¼Œè€Œ**ã€ŒğŸ’¡`AuthenticationEntryPoint`ã€** åˆ™ä¸“é—¨å¤„ç†è®¤è¯å¼‚å¸¸ï¼

### è®¤è¯å¼‚å¸¸å¤„ç†å™¨AuthenticationEntryPoint

è¯¥æ¥å£ä¹Ÿåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š

```java
public interface AuthenticationEntryPoint {
 /**
  * æ¥æ”¶å¼‚å¸¸å¹¶å¤„ç†
  */
 void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException);
}
```

æˆ‘ä»¬æ¥è‡ªå®šä¹‰ä¸€ä¸ªç±»å®ç°æˆ‘ä»¬è‡ªå·±çš„é”™è¯¯å¤„ç†é€»è¾‘ï¼š

```java
public class MyEntryPoint implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException {
        response.setContentType("application/json;charset=utf-8");
        PrintWriter out = response.getWriter();
        // ç›´æ¥æç¤ºå‰ç«¯è®¤è¯é”™è¯¯
        out.write("è®¤è¯é”™è¯¯");
        out.flush();
        out.close();
    }
}
```

ç”¨æˆ·ä¼ é€’è¿‡æ¥è´¦å·å¯†ç ğŸ‘‰è®¤è¯æ ¡éªŒğŸ‘‰å¼‚å¸¸å¤„ç†ï¼Œè¿™ä¸€æ•´å¥—æµç¨‹çš„ç»„ä»¶æˆ‘ä»¬å°±éƒ½ç»™å®šä¹‰å®Œäº†ï¼ç°åœ¨åªå·®æœ€åä¸€æ­¥ï¼Œå°±æ˜¯åœ¨Spring Securityé…ç½®ç±»é‡Œé¢è¿›è¡Œä¸€äº›é…ç½®ï¼Œæ‰èƒ½è®©è¿™äº›ç”Ÿæ•ˆã€‚

### é…ç½®

Spring Securityå¯¹å“ªäº›æ¥å£è¿›è¡Œä¿æŠ¤ã€ä»€ä¹ˆç»„ä»¶ç”Ÿæ•ˆã€æŸäº›åŠŸèƒ½æ˜¯å¦å¯ç”¨ç­‰ç­‰éƒ½éœ€è¦åœ¨é…ç½®ç±»ä¸­è¿›è¡Œé…ç½®ï¼Œæ³¨æ„çœ‹ä»£ç æ³¨é‡Šï¼š

```java
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    private UserServiceImpl userDetailsService;

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // å…³é—­csrfå’ŒframeOptionsï¼Œå¦‚æœä¸å…³é—­ä¼šå½±å“å‰ç«¯è¯·æ±‚æ¥å£ï¼ˆè¿™é‡Œä¸å±•å¼€ç»†è®²äº†ï¼Œæ„Ÿå…´è¶£çš„è‡ªè¡Œäº†è§£ï¼‰
        http.csrf().disable();
        http.headers().frameOptions().disable();
        // å¼€å¯è·¨åŸŸä»¥ä¾¿å‰ç«¯è°ƒç”¨æ¥å£
        http.cors();

        // è¿™æ˜¯é…ç½®çš„å…³é”®ï¼Œå†³å®šå“ªäº›æ¥å£å¼€å¯é˜²æŠ¤ï¼Œå“ªäº›æ¥å£ç»•è¿‡é˜²æŠ¤
        http.authorizeRequests()
             // æ³¨æ„è¿™é‡Œï¼Œæ˜¯å…è®¸å‰ç«¯è·¨åŸŸè”è°ƒçš„ä¸€ä¸ªå¿…è¦é…ç½®
                .requestMatchers(CorsUtils::isPreFlightRequest).permitAll()
                // æŒ‡å®šæŸäº›æ¥å£ä¸éœ€è¦é€šè¿‡éªŒè¯å³å¯è®¿é—®ã€‚ç™»é™†ã€æ³¨å†Œæ¥å£è‚¯å®šæ˜¯ä¸éœ€è¦è®¤è¯çš„
                .antMatchers("/API/login", "/API/register").permitAll()
                // è¿™é‡Œæ„æ€æ˜¯å…¶å®ƒæ‰€æœ‰æ¥å£éœ€è¦è®¤è¯æ‰èƒ½è®¿é—®
                .anyRequest().authenticated()
                // æŒ‡å®šè®¤è¯é”™è¯¯å¤„ç†å™¨
                .and().exceptionHandling().authenticationEntryPoint(new MyEntryPoint());
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        // æŒ‡å®šUserDetailServiceå’ŒåŠ å¯†å™¨
        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());
    }

    @Bean
    @Override
    protected AuthenticationManager authenticationManager() throws Exception {
        return super.authenticationManager();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

å…¶ä¸­ç”¨çš„æœ€å¤šçš„å°±æ˜¯`configure(HttpSecurity http)`æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡`HttpSecurity`è¿›è¡Œè®¸å¤šé…ç½®ã€‚å½“æˆ‘ä»¬é‡å†™è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œå°±å·²ç»å…³é—­äº†é»˜è®¤çš„è¡¨å•ç™»å½•æ–¹å¼ï¼Œç„¶åæˆ‘ä»¬å†é…ç½®å¥½å¯ç”¨å“ªäº›ç»„ä»¶ã€æŒ‡å®šå“ªäº›æ¥å£éœ€è¦è®¤è¯ï¼Œå°±æå®šäº†ï¼

å‡è®¾ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª`/API/test`æ¥å£ï¼Œåœ¨æ²¡æœ‰ç™»å½•çš„æ—¶å€™è°ƒç”¨è¯¥æ¥å£çœ‹ä¸‹æ•ˆæœï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/8.jpg)

æˆ‘ä»¬ç™»å½•ä¸€ä¸‹ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/9.jpg)

ç„¶åå†è°ƒç”¨æµ‹è¯•æ¥å£ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/10.jpg)

å¯ä»¥çœ‹åˆ°æœªç™»å½•æ—¶æµ‹è¯•æ¥å£æ˜¯æ— æ³•æ­£å¸¸è®¿é—®çš„ï¼Œä¼šæŒ‰ç…§æˆ‘ä»¬åœ¨`EntryPoint`ä¸­çš„é€»è¾‘è¿”å›é”™è¯¯æç¤ºã€‚

### æ€»ç»“å’Œè¡¥å……

æœ‰äººå¯èƒ½ä¼šé—®ï¼Œç”¨`AuthenticationManager`è®¤è¯æ–¹å¼è¦é…ç½®å¥½å¤šä¸œè¥¿å•Šï¼Œæˆ‘å°±ç”¨ä¹‹å‰è¯´çš„é‚£ç§æœ€ç®€å•çš„æ–¹å¼ä¸è¡Œå—ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„å•¦ï¼Œç”¨å“ªç§æ–¹å¼éƒ½éšä¾¿ï¼Œåªè¦å®ŒæˆåŠŸèƒ½éƒ½è¡Œã€‚å…¶å®ä¸ç®¡å“ªç§æ–¹å¼æˆ‘ä»¬çš„è®¤è¯çš„é€»è¾‘ä»£ç ä¸€æ ·éƒ½æ²¡å°‘ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯æˆ‘ä»¬è‡ªå·±ä¸šåŠ¡ç±»å…¨éƒ¨æå®šï¼Œä¸€ä¸ªæ˜¯å¯ä»¥é›†æˆæ¡†æ¶çš„ç»„ä»¶ã€‚è¿™é‡Œä¹Ÿé¡ºå¸¦å†æ€»ç»“ä¸€ä¸‹æµç¨‹ï¼š

1. ç”¨æˆ·è¿›è¡Œç™»å½•æ“ä½œï¼Œä¼ é€’è´¦å·å¯†ç è¿‡æ¥ğŸ‘‰ç™»å½•æ¥å£è°ƒç”¨`AuthenticationManager`
2. æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·æ•°æ®ğŸ‘‰`UserDetailService`æŸ¥è¯¢å‡º`UserDetails`
3. å°†ä¼ é€’è¿‡æ¥çš„å¯†ç å’Œæ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œå¯¹æ¯”æ ¡éªŒğŸ‘‰`PasswordEncoder`
4. æ ¡éªŒé€šè¿‡åˆ™å°†è®¤è¯ä¿¡æ¯å­˜å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ğŸ‘‰å°†`UserDetails`å­˜å…¥åˆ°`Authentication`ï¼Œå°†`Authentication`å­˜å…¥åˆ°`SecurityContext`
5. å¦‚æœè®¤è¯å¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ğŸ‘‰ç”±`AuthenticationEntryPoint`å¤„ç†

åˆšæ‰æˆ‘ä»¬è®²çš„è®¤è¯æ–¹å¼éƒ½æ˜¯åŸºäº`session`æœºåˆ¶ï¼Œè®¤è¯åSpring Securityä¼šå°†`Authentication`å­˜å…¥åˆ°`session`ä¸­ï¼ŒKeyä¸º`HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY`ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å®Œå…¨å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–`Authentication`ï¼š

```java
Authentication = (Authentication)session.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY)
```

å½“ç„¶ï¼Œå®˜æ–¹è¿˜æ˜¯ä¸æ¨èè¿™æ ·ç›´æ¥æ“ä½œçš„ï¼Œå› ä¸ºç»Ÿä¸€é€šè¿‡`SecurityContextHolder`æ“ä½œæ›´åˆ©äºç®¡ç†ï¼ä½¿ç”¨`SecurityContextHolder`é™¤äº†è·å–å½“å‰ç”¨æˆ·å¤–ï¼Œé€€å‡ºç™»å½•çš„æ“ä½œä¹Ÿæ˜¯å¾ˆæ–¹ä¾¿çš„ï¼š

```java
@GetMapping("/logout")
public String logout() {
    SecurityContextHolder.clearContext();
    return "é€€å‡ºæˆåŠŸ";
}
```

`session`è®¤è¯å’±ä»¬å°±è®²è§£åˆ°æ­¤ï¼Œæ¥ä¸‹æ¥å’±ä»¬è®²è§£`JWT`çš„è®¤è¯ã€‚

## JWTé›†æˆ

å…³äº`JWT`çš„ä»‹ç»å’Œå·¥å…·ç±»ç­‰æˆ‘åœ¨å‰é¢æ–‡ç« å·²ç»è®²çš„å¾ˆæ¸…æ¥šäº†ï¼Œè¿™é‡Œæˆ‘å°±ä¸é¢å¤–è¯´æ˜äº†ï¼Œç›´æ¥å¸¦å¤§å®¶å®ç°ä»£ç ã€‚

é‡‡ç”¨`JWT`çš„æ–¹å¼è¿›è¡Œè®¤è¯é¦–å…ˆåšçš„ç¬¬ä¸€æ­¥å°±æ˜¯åœ¨é…ç½®ç±»é‡Œç¦ç”¨æ‰`session`ï¼š

```java
// ç¦ç”¨session
http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);
```

> æ³¨æ„ï¼Œè¿™é‡Œçš„ç¦ç”¨æ˜¯æŒ‡Spring Securityä¸é‡‡ç”¨`session`æœºåˆ¶äº†ï¼Œä¸ä»£è¡¨ä½ ç¦ç”¨æ‰äº†æ•´ä¸ªç³»ç»Ÿçš„`session`åŠŸèƒ½ã€‚

ç„¶åæˆ‘ä»¬å†ä¿®æ”¹ä¸€ä¸‹ç™»å½•æ¥å£ï¼Œå½“ç”¨æˆ·ç™»å½•æˆåŠŸçš„åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆ`token`å¹¶è¿”å›ç»™å‰ç«¯ï¼Œè¿™æ ·å‰ç«¯æ‰èƒ½è®¿é—®å…¶ä»–æ¥å£æ—¶æºå¸¦`token`ï¼š

```java
@Autowired
private UserService userService;

@PostMapping("/login")
public UserVO login(@RequestBody @Validated LoginParam user) {
    // è°ƒç”¨ä¸šåŠ¡å±‚æ‰§è¡Œç™»å½•æ“ä½œ
    return userService.login(user);
}
```

ä¸šåŠ¡å±‚æ–¹æ³•ï¼š

```java
public UserVO login(LoginParam param) {
    // æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·å®ä½“å¯¹è±¡
    UserEntity user = userMapper.selectByUsername(param.getUsername());
    // è‹¥æ²¡æœ‰æŸ¥åˆ°ç”¨æˆ· æˆ–è€… å¯†ç æ ¡éªŒå¤±è´¥åˆ™æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸
    if (user == null || !passwordEncoder.matches(param.getPassword(), user.getPassword())) {
        throw new ApiException("è´¦å·å¯†ç é”™è¯¯");
    }

    // éœ€è¦è¿”å›ç»™å‰ç«¯çš„VOå¯¹è±¡
    UserVO userVO = new UserVO();
    userVO.setId(user.getId())
        .setUsername(user.getUsername())
        // ç”ŸæˆJWTï¼Œå°†ç”¨æˆ·åæ•°æ®å­˜å…¥å…¶ä¸­
        .setToken(jwtManager.generate(user.getUsername()));
    return userVO;
}
```

æˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ç™»å½•æ“ä½œï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/11.jpg)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç™»å½•æˆåŠŸæ—¶æ¥å£ä¼šè¿”å›`token`ï¼Œåç»­æˆ‘ä»¬å†è®¿é—®å…¶å®ƒæ¥å£æ—¶éœ€è¦å°†`token`æ”¾åˆ°è¯·æ±‚å¤´ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªè®¤è¯è¿‡æ»¤å™¨ï¼Œæ¥å¯¹`token`è¿›è¡Œæ ¡éªŒï¼š

```java
@Component
public class LoginFilter extends OncePerRequestFilter {
    @Autowired
    private JwtManager jwtManager;
    @Autowired
    private UserServiceImpl userService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException {
        // ä»è¯·æ±‚å¤´ä¸­è·å–tokenå­—ç¬¦ä¸²å¹¶è§£æï¼ˆJwtManagerä¹‹å‰æ–‡ç« æœ‰è¯¦è§£ï¼Œè¿™é‡Œä¸å¤šè¯´äº†ï¼‰
        Claims claims = jwtManager.parse(request.getHeader("Authorization"));
        if (claims != null) {
            // ä»`JWT`ä¸­æå–å‡ºä¹‹å‰å­˜å‚¨å¥½çš„ç”¨æˆ·å
            String username = claims.getSubject();
            // æŸ¥è¯¢å‡ºç”¨æˆ·å¯¹è±¡
            UserDetails user = userService.loadUserByUsername(username);
            // æ‰‹åŠ¨ç»„è£…ä¸€ä¸ªè®¤è¯å¯¹è±¡
            Authentication authentication = new UsernamePasswordAuthenticationToken(user, user.getPassword(), user.getAuthorities());
            // å°†è®¤è¯å¯¹è±¡æ”¾åˆ°ä¸Šä¸‹æ–‡ä¸­
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
        chain.doFilter(request, response);
    }
}
```

è¿‡æ»¤å™¨ä¸­çš„é€»è¾‘å’Œä¹‹å‰ä»‹ç»çš„**ã€Œæœ€ç®€å•çš„è®¤è¯æ–¹å¼ã€**é€»è¾‘æ˜¯ä¸€è‡´çš„ï¼Œæ¯å½“ä¸€ä¸ªè¯·æ±‚æ¥æ—¶æˆ‘ä»¬éƒ½ä¼šæ ¡éªŒ`JWT`è¿›è¡Œè®¤è¯ï¼Œä¸Šä¸‹æ–‡å¯¹è±¡ä¸­æœ‰äº†`Authentication`åç»­è¿‡æ»¤å™¨å°±ä¼šçŸ¥é“è¯¥è¯·æ±‚å·²ç»è®¤è¯è¿‡äº†ã€‚

å’±ä»¬è¿™ä¸ªè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨éœ€è¦æ›¿æ¢æ‰Spring Securityé»˜è®¤çš„è®¤è¯è¿‡æ»¤å™¨ï¼Œè¿™æ ·æˆ‘ä»¬çš„è¿‡æ»¤å™¨æ‰èƒ½ç”Ÿæ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š

```java
// å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„è®¤è¯è¿‡æ»¤å™¨æ›¿æ¢æ‰é»˜è®¤çš„è®¤è¯è¿‡æ»¤å™¨
http.addFilterBefore(loginFilter, UsernamePasswordAuthenticationFilter.class);
```

æˆ‘ä»¬å¯ä»¥æ–­ç‚¹è°ƒè¯•çœ‹ä¸€ä¸‹ç°åœ¨çš„è¿‡æ»¤å™¨æ˜¯æ€æ ·çš„ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/12.jpg)

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨å·²ç»æ›¿æ¢æ‰äº†`UsernamePasswordAuthenticationFilter`é»˜è®¤è¿‡æ»¤å™¨äº†ï¼å½“æˆ‘ä»¬æºå¸¦`token`è®¿é—®æ¥å£æ—¶å¯ä»¥å‘ç°å·²ç»ç”Ÿæ•ˆï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/13.jpg)

ç™»å½•è®¤è¯åˆ°æ­¤å°±è®²è§£å®Œæ¯•äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€é¼“ä½œæ°”æ¥å®ç°æƒé™æˆæƒï¼

# æƒé™æˆæƒ

èœå•æƒé™ä¸»è¦æ˜¯é€šè¿‡å‰ç«¯æ¸²æŸ“ï¼Œæ•°æ®æƒé™ä¸»è¦é `SQL`æ‹¦æˆªï¼Œå’ŒSpring Securityæ²¡å¤ªå¤§è€¦åˆï¼Œå°±ä¸å¤šå±•å¼€äº†ã€‚æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹**ã€Œæ¥å£æƒé™ã€**çš„æˆæƒçš„æµç¨‹ï¼š

1. å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥ï¼Œæˆ‘ä»¬å…ˆå¾—çŸ¥é“è¿™ä¸ªè¯·æ±‚çš„è§„åˆ™ï¼Œå³éœ€è¦æ€æ ·çš„æƒé™æ‰èƒ½è®¿é—®
2. ç„¶åè·å–å½“å‰ç™»å½•ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™
3. å†æ ¡éªŒå½“å‰ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è¯¥è¯·æ±‚çš„æƒé™
4. ç”¨æˆ·æ‹¥æœ‰è¿™ä¸ªæƒé™åˆ™æ­£å¸¸è¿”å›æ•°æ®ï¼Œæ²¡æœ‰æƒé™åˆ™æ‹’ç»è¯·æ±‚

å®Œæˆäº†ç™»å½•è®¤è¯åŠŸèƒ½åï¼Œæƒ³å¿…å¤§å®¶å·²ç»æœ‰ç‚¹æ„Ÿè§‰ï¼šSpring Securityå°†æµç¨‹åŠŸèƒ½åˆ†å¾—å¾ˆç»†ï¼Œæ¯ä¸€ä¸ªå°åŠŸèƒ½éƒ½ä¼šæœ‰ä¸€ä¸ªç»„ä»¶ä¸“é—¨å»åšï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯å»è‡ªå®šä¹‰è¿™äº›ç»„ä»¶ï¼Spring Securityé’ˆå¯¹ä¸Šè¿°æµç¨‹ä¹Ÿæä¾›äº†è®¸å¤šç»„ä»¶ã€‚

Spring Securityçš„æˆæƒå‘ç”Ÿåœ¨`FilterSecurityInterceptor`è¿‡æ»¤å™¨ä¸­ï¼š

1. é¦–å…ˆè°ƒç”¨çš„æ˜¯**ã€ŒğŸ’¡`SecurityMetadataSource`ã€**ï¼Œæ¥è·å–å½“å‰è¯·æ±‚çš„é‰´æƒè§„åˆ™
2. ç„¶åé€šè¿‡`Authentication`è·å–å½“å‰ç™»å½•ç”¨æˆ·æ‰€æœ‰æƒé™æ•°æ®ï¼š**ã€ŒğŸ’¡`GrantedAuthority`ã€**ï¼Œè¿™ä¸ªæˆ‘ä»¬å‰é¢æè¿‡ï¼Œè®¤è¯å¯¹è±¡é‡Œå­˜æ”¾è¿™ä¸ªæƒé™æ•°æ®
3. å†è°ƒç”¨**ã€ŒğŸ’¡`AccessDecisionManager`ã€** æ¥æ ¡éªŒå½“å‰ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è¯¥æƒé™
4. å¦‚æœæœ‰å°±æ”¾è¡Œæ¥å£ï¼Œæ²¡æœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸ä¼šè¢«**ã€ŒğŸ’¡`AccessDeniedHandler`ã€** å¤„ç†

æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹è¿‡æ»¤å™¨é‡Œå¤§æ¦‚çš„æºç ï¼š

```java
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
    ...çœç•¥å…¶å®ƒä»£ç 
        
    // è¿™æ˜¯Spring Securityå°è£…çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡é‡ŒåŒ…å«äº†requestç­‰ä¿¡æ¯
    FilterInvocation fi = new FilterInvocation(request, response, chain);
    // è¿™é‡Œè°ƒç”¨äº†çˆ¶ç±»çš„AbstractSecurityInterceptorçš„æ–¹æ³•,è®¤è¯æ ¸å¿ƒé€»è¾‘åŸºæœ¬å…¨åœ¨çˆ¶ç±»é‡Œ
    InterceptorStatusToken token = super.beforeInvocation(fi);

    ...çœç•¥å…¶å®ƒä»£ç 
}
```

çˆ¶ç±»çš„`beforeInvocation`å¤§æ¦‚æºç å¦‚ä¸‹ï¼š

```java
protected InterceptorStatusToken beforeInvocation(Object object) {
    ...çœç•¥å…¶å®ƒä»£ç 
    
    // è°ƒç”¨SecurityMetadataSourceæ¥è·å–å½“å‰è¯·æ±‚çš„é‰´æƒè§„åˆ™ï¼Œè¿™ä¸ªConfigAttribueå°±æ˜¯è§„åˆ™ï¼Œåé¢æˆ‘ä¼šè®²
    Collection<ConfigAttribute> attributes = this.obtainSecurityMetadataSource().getAttributes(object);
    // å¦‚æœå½“å‰è¯·æ±‚å•¥è§„åˆ™ä¹Ÿæ²¡æœ‰ï¼Œå°±ä»£è¡¨è¯¥è¯·æ±‚æ— éœ€æˆæƒå³å¯è®¿é—®ï¼Œç›´æ¥ç»“æŸæ–¹æ³•
    if (CollectionUtils.isEmpty(attributes)) {
        return null;
    }
    
    // è·å–å½“å‰ç™»å½•ç”¨æˆ·
    Authentication authenticated = authenticateIfRequired();
    // è°ƒç”¨AccessDecisionManageræ¥æ ¡éªŒå½“å‰ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è¯¥æƒé™ï¼Œæ²¡æœ‰æƒé™åˆ™æŠ›å‡ºå¼‚å¸¸
    this.accessDecisionManager.decide(authenticated, object, attributes);
    
    ...çœç•¥å…¶å®ƒä»£ç 
}
```

è€ç”Ÿå¸¸è°ˆï¼Œæ ¸å¿ƒæµç¨‹éƒ½æ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥è‡ªå®šä¹‰è¿™äº›ç»„ä»¶ï¼Œä»¥å®Œæˆæˆ‘ä»¬è‡ªå·±çš„é‰´æƒé€»è¾‘ã€‚

## é‰´æƒè§„åˆ™æºSecurityMetadataSource

è¯¥æ¥å£æˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸€ä¸ªæ–¹æ³•ï¼š

```java
public interface SecurityMetadataSource {
 /**
  * è·å–å½“å‰è¯·æ±‚çš„é‰´æƒè§„åˆ™
  
  * @param object è¯¥å‚æ•°å°±æ˜¯Spring Securityå°è£…çš„FilterInvocationå¯¹è±¡ï¼ŒåŒ…å«äº†å¾ˆå¤šrequestä¿¡æ¯
  * @return é‰´æƒè§„åˆ™å¯¹è±¡
  */
 Collection<ConfigAttribute> getAttributes(Object object);

}
```

`ConfigAttribute`å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„é‰´æƒè§„åˆ™ï¼Œè¯¥æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š

```java
public interface ConfigAttribute {
 /**
  * è¿™ä¸ªå­—ç¬¦ä¸²å°±æ˜¯è§„åˆ™ï¼Œå®ƒå¯ä»¥æ˜¯è§’è‰²åã€æƒé™åã€è¡¨è¾¾å¼ç­‰ç­‰ã€‚
  * ä½ å®Œå…¨å¯ä»¥æŒ‰ç…§è‡ªå·±æƒ³æ³•æ¥å®šä¹‰ï¼Œåé¢AccessDecisionManagerä¼šç”¨è¿™ä¸ªå­—ç¬¦ä¸²
  */
 String getAttribute();
}
```

åœ¨ä¹‹å‰æ–‡ç« ä¸­æˆ‘ä»¬æˆæƒçš„å®ç°å…¨æ˜¯é ç€èµ„æº`id`ï¼Œç”¨æˆ·`id`å…³è”è§’è‰²`id`ï¼Œè§’è‰²`id`å…³è”èµ„æº`id`ï¼Œè¿™æ ·ç”¨æˆ·å°±ç›¸å½“äºå…³è”äº†èµ„æºï¼Œè€Œæˆ‘ä»¬æ¥å£èµ„æºåœ¨æ•°æ®åº“ä¸­çš„ä½“ç°æ˜¯è¿™æ ·çš„ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/14.jpg)

è¿™é‡Œè¿˜æ˜¯ä¸€æ ·ï¼Œæˆ‘ä»¬ç…§æ ·ä»¥èµ„æº`id`ä½œä¸ºæƒé™çš„æ ‡è®°ã€‚æ¥ä¸‹å’±ä»¬å°±æ¥è‡ªå®šä¹‰`SecurityMetadataSource`ç»„ä»¶ï¼š

```java
@Component
public class MySecurityMetadataSource implements SecurityMetadataSource {
    /**
     * å½“å‰ç³»ç»Ÿæ‰€æœ‰æ¥å£èµ„æºå¯¹è±¡ï¼Œæ”¾åœ¨è¿™é‡Œç›¸å½“äºä¸€ä¸ªç¼“å­˜çš„åŠŸèƒ½ã€‚
     * ä½ å¯ä»¥åœ¨åº”ç”¨å¯åŠ¨æ—¶å°†è¯¥ç¼“å­˜ç»™åˆå§‹åŒ–ï¼Œä¹Ÿå¯ä»¥åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­åŠ è½½æ•°æ®ï¼Œè¿™é‡Œæˆ‘å°±ä¸å¤šå±•å¼€è¯´æ˜äº†
     */
    private static final Set<Resource> RESOURCES = new HashSet<>();

    @Override
    public Collection<ConfigAttribute> getAttributes(Object object) {
        // è¯¥å¯¹è±¡æ˜¯Spring Securityå¸®æˆ‘ä»¬å°è£…å¥½çš„ï¼Œå¯ä»¥é€šè¿‡è¯¥å¯¹è±¡è·å–requestç­‰ä¿¡æ¯
        FilterInvocation filterInvocation = (FilterInvocation) object;
        HttpServletRequest request = filterInvocation.getRequest();
        // éå†æ‰€æœ‰æƒé™èµ„æºï¼Œä»¥å’Œå½“å‰è¯·æ±‚è¿›è¡ŒåŒ¹é…
        for (Resource resource : RESOURCES) {
            // å› ä¸ºæˆ‘ä»¬urlèµ„æºæ˜¯è¿™ç§æ ¼å¼ï¼šGET:/API/user/test/{id}ï¼Œå†’å·å‰é¢æ˜¯è¯·æ±‚æ–¹æ³•ï¼Œå†’å·åé¢æ˜¯è¯·æ±‚è·¯å¾„ï¼Œæ‰€ä»¥è¦å­—ç¬¦ä¸²æ‹†åˆ†
            String[] split = resource.getPath().split(":");
            // å› ä¸º/API/user/test/{id}è¿™ç§è·¯å¾„å‚æ•°ä¸èƒ½ç›´æ¥equalsæ¥åˆ¤æ–­è¯·æ±‚è·¯å¾„æ˜¯å¦åŒ¹é…ï¼Œæ‰€ä»¥éœ€è¦ç”¨Antç±»æ¥åŒ¹é…
            AntPathRequestMatcher ant = new AntPathRequestMatcher(split[1]);
            // å¦‚æœè¯·æ±‚æ–¹æ³•å’Œè¯·æ±‚è·¯å¾„éƒ½åŒ¹é…ä¸Šäº†ï¼Œåˆ™ä»£è¡¨æ‰¾åˆ°äº†è¿™ä¸ªè¯·æ±‚æ‰€éœ€çš„æƒé™èµ„æº
            if (request.getMethod().equals(split[0]) && ant.matches(request)) {
                // å°†æˆ‘ä»¬æƒé™èµ„æºidè¿”å›ï¼Œè¿™ä¸ªSecurityConfigå°±æ˜¯ConfigAttributeä¸€ä¸ªç®€å•å®ç°
                return Collections.singletonList(new SecurityConfig(resource.getId().toString()));
            }
        }
        // èµ°åˆ°è¿™é‡Œå°±ä»£è¡¨è¯¥è¯·æ±‚æ— éœ€æˆæƒå³å¯è®¿é—®ï¼Œè¿”å›ç©º
        return null;
    }

    @Override
    public Collection<ConfigAttribute> getAllConfigAttributes() {
        // ä¸ç”¨ç®¡ï¼Œè¿™ä¹ˆå†™å°±è¡Œ
        return null;
    }

    @Override
    public boolean supports(Class<?> clazz) {
        // ä¸ç”¨ç®¡ï¼Œè¿™ä¹ˆå†™å°±è¡Œ
        return true;
    }
}
```

æ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œè¿”å›çš„`ConfigAttribute`é‰´æƒè§„åˆ™ï¼Œå°±æ˜¯æˆ‘ä»¬çš„èµ„æº`id`ã€‚

##  ç”¨æˆ·æƒé™GrantedAuthority

è¯¥ç»„ä»¶ä»£è¡¨ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™ï¼Œå’Œ`ConfigAttribute`ä¸€æ ·ä¹Ÿåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›çš„å­—ç¬¦ä¸²å°±æ˜¯ä»£è¡¨ç€æƒé™

```java
public interface GrantedAuthority extends Serializable {
 String getAuthority();
}
```

å°†`GrantedAuthority`å’Œ`ConfigAttribute`ä¸€å¯¹æ¯”ï¼Œå°±çŸ¥é“ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªæƒé™äº†ã€‚

Spring Securityå¯¹`GrantedAuthority`æœ‰ä¸€ä¸ªç®€å•å®ç°`SimpleGrantedAuthority`ï¼Œå¯¹å’±ä»¬æ¥è¯´å¤Ÿç”¨äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬é¢å¤–å†æ–°å»ºä¸€ä¸ªå®ç°ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯åœ¨`UserDetialsService`ä¸­ï¼Œè·å–ç”¨æˆ·å¯¹è±¡çš„åŒæ—¶ä¹Ÿå°†æƒé™æ•°æ®æŸ¥è¯¢å‡ºæ¥ï¼š

```java
@Override
public UserDetails loadUserByUsername(String username) {
    UserEntity user = userMapper.selectByUsername(username);
    if (user == null) {
        throw new UsernameNotFoundException("æ²¡æœ‰æ‰¾åˆ°è¯¥ç”¨æˆ·");
    }
    // å…ˆå°†è¯¥ç”¨æˆ·æ‰€æ‹¥æœ‰çš„èµ„æºidå…¨éƒ¨æŸ¥è¯¢å‡ºæ¥ï¼Œå†è½¬æ¢æˆ`SimpleGrantedAuthority`æƒé™å¯¹è±¡
    Set<SimpleGrantedAuthority> authorities = resourceService.getIdsByUserId(user.getId())
        .stream()
        .map(String::valueOf)
        .map(SimpleGrantedAuthority::new)
        .collect(Collectors.toSet());
    // å°†ç”¨æˆ·å®ä½“å’Œæƒé™é›†åˆéƒ½æ”¾åˆ°UserDetailä¸­ï¼Œ
    return new UserDetail(user, authorities);
}
```

è¿™æ ·å½“è®¤è¯å®Œæ¯•æ—¶ï¼Œ`Authentication`å°±ä¼šæ‹¥æœ‰ç”¨æˆ·ä¿¡æ¯å’Œæƒé™æ•°æ®äº†ã€‚

## æˆæƒç®¡ç†AccessDecisionManager

ç»ˆäºè¦æ¥åˆ°æˆ‘ä»¬çœŸæ­£çš„æˆæƒç»„ä»¶äº†ï¼Œè¿™ä¸ªç»„ä»¶æ‰æœ€ç»ˆå†³å®šäº†ä½ æœ‰æ²¡æœ‰æŸä¸ªæƒé™ï¼Œè¯¥æ¥å£æˆ‘ä»¬åªéœ€å…³æ³¨ä¸€ä¸ªæ–¹æ³•ï¼š

```java
public interface AccessDecisionManager {

 /**
  * æˆæƒæ“ä½œï¼Œå¦‚æœæ²¡æœ‰æƒé™åˆ™æŠ›å‡ºå¼‚å¸¸ 
  *
     * @param authentication å½“å‰ç™»å½•ç”¨æˆ·ï¼Œä»¥è·å–å½“å‰ç”¨æˆ·æƒé™ä¿¡æ¯
  * @param object FilterInvocationå¯¹è±¡ï¼Œä»¥è·å–requestä¿¡æ¯
  * @param configAttributes å½“å‰è¯·æ±‚é‰´æƒè§„åˆ™
  */
 void decide(Authentication authentication, Object object, Collection<ConfigAttribute> configAttributes)
   throws AccessDeniedException, InsufficientAuthenticationException;
}
```

è¯¥æ–¹æ³•æ¥å—äº†è¿™å‡ ä¸ªå‚æ•°åå®Œå…¨èƒ½åšåˆ°æƒé™æ ¡éªŒäº†ï¼Œæˆ‘ä»¬æ¥å®ç°è‡ªå·±çš„é€»è¾‘ï¼š

```java
@Component
public class MyDecisionManager implements AccessDecisionManager {
    @Override
    public void decide(Authentication authentication, Object object, Collection<ConfigAttribute> configAttributes) {
        // å¦‚æœæˆæƒè§„åˆ™ä¸ºç©ºåˆ™ä»£è¡¨æ­¤URLæ— éœ€æˆæƒå°±èƒ½è®¿é—®
        if (Collections.isEmpty(configAttributes)) {
            return;
        }
        // åˆ¤æ–­æˆæƒè§„åˆ™å’Œå½“å‰ç”¨æˆ·æ‰€å±æƒé™æ˜¯å¦åŒ¹é…
        for (ConfigAttribute ca : configAttributes) {
            for (GrantedAuthority authority : authentication.getAuthorities()) {
                // å¦‚æœåŒ¹é…ä¸Šäº†ï¼Œä»£è¡¨å½“å‰ç™»å½•ç”¨æˆ·æ˜¯æœ‰è¯¥æƒé™çš„ï¼Œç›´æ¥ç»“æŸæ–¹æ³•
                if (Objects.equals(authority.getAuthority(), ca.getAttribute())) {
                    return;
                }
            }
        }
        // èµ°åˆ°è¿™é‡Œå°±ä»£è¡¨æ²¡æœ‰æƒé™ï¼Œå¿…é¡»è¦æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™é”™è¯¯å¤„ç†å™¨æ•æ‰ä¸åˆ°
        throw new AccessDeniedException("æ²¡æœ‰ç›¸å…³æƒé™");
    }

    @Override
    public boolean supports(ConfigAttribute attribute) {
        // ä¸ç”¨ç®¡ï¼Œè¿™ä¹ˆå†™å°±è¡Œ
        return true;
    }

    @Override
    public boolean supports(Class<?> clazz) {
        // ä¸ç”¨ç®¡ï¼Œè¿™ä¹ˆå†™å°±è¡Œ
        return true;
    }
}
```

## æˆæƒé”™è¯¯å¤„ç†å™¨AccessDeniedHandler

è¯¥ç»„ä»¶å’Œä¹‹å‰çš„è®¤è¯å¼‚å¸¸å¤„ç†å™¨ä¸€æ ·ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•ç”¨æ¥å¤„ç†å¼‚å¸¸ï¼Œåªä¸è¿‡è¿™ä¸ªæ˜¯ç”¨æ¥å¤„ç†æˆæƒå¼‚å¸¸çš„ã€‚æˆ‘ä»¬ç›´æ¥æ¥å®ç°ï¼š

```java
public class MyDeniedHandler implements AccessDeniedHandler {
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException, ServletException {
        response.setContentType("application/json;charset=utf-8");
        out.write("æ²¡æœ‰ç›¸å…³æƒé™");
        out.flush();
        out.close();
    }
}
```

## é…ç½®

ç»„ä»¶éƒ½å®šä¹‰å¥½äº†ï¼Œé‚£æˆ‘ä»¬æ¥ä¸‹æ¥å°±æ˜¯æœ€åä¸€æ­¥å’¯ï¼Œå°±æ˜¯è®©è¿™äº›ç»„ä»¶ç”Ÿæ•ˆã€‚æˆ‘ä»¬çš„é‰´æƒè§„åˆ™æºç»„ä»¶`SecurityMetadataSource`å’Œæˆæƒç®¡ç†ç»„ä»¶`AccessDecisionManager`å¿…é¡»é€šè¿‡æˆæƒè¿‡æ»¤å™¨`FilterSecurityInterceptor`æ¥é…ç½®ç”Ÿæ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—è‡ªå·±å…ˆå†™ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨çš„æ ¸å¿ƒä»£ç åŸºæœ¬æŒ‰ç…§çˆ¶ç±»çš„å†™å°±è¡Œï¼Œä¸»è¦å°±æ˜¯å±æ€§çš„é…ç½®ï¼š

```java
@Component
public class AuthFilter extends AbstractSecurityInterceptor implements Filter {
    @Autowired
    private SecurityMetadataSource securityMetadataSource;

    @Override
    public SecurityMetadataSource obtainSecurityMetadataSource() {
        // å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„SecurityMetadataSourceç»™è¿”å›
        return this.securityMetadataSource;
    }

    @Override
    @Autowired
    public void setAccessDecisionManager(AccessDecisionManager accessDecisionManager) {
        // å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„AccessDecisionManagerç»™æ³¨å…¥
        super.setAccessDecisionManager(accessDecisionManager);
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        // ä¸‹é¢çš„å°±æ˜¯æŒ‰ç…§çˆ¶ç±»å†™æ³•å†™çš„
        FilterInvocation fi = new FilterInvocation(request, response, chain);
        InterceptorStatusToken token = super.beforeInvocation(fi);
        try {
            // æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨
            fi.getChain().doFilter(fi.getRequest(), fi.getResponse());
        }  finally {
            // è¯·æ±‚ä¹‹åçš„å¤„ç†
            super.afterInvocation(token, null);
        }
    }

    @Override
    public Class<?> getSecureObjectClass() {
        return FilterInvocation.class;
    }

    @Override
    public void init(FilterConfig filterConfig) {}

    @Override
    public void destroy() {}
}
```

è¿‡æ»¤å™¨å®šä¹‰å¥½äº†ï¼Œæˆ‘ä»¬å›åˆ°Spring Securityé…ç½®ç±»è®©è¿™ä¸ªè¿‡æ»¤å™¨æ›¿æ¢æ‰åŸæœ‰çš„è¿‡æ»¤å™¨å°±ä¸€åˆ‡éƒ½æå®šå•¦ï¼š

```java
http.addFilterBefore(authFilter, FilterSecurityInterceptor.class);
```

æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸‹æ•ˆæœï¼Œæ²¡æœ‰æƒé™çš„æƒ…å†µä¸‹è®¿é—®æ¥å£ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/15.jpg)

æœ‰æƒé™çš„æƒ…å†µä¸‹è®¿é—®æ¥å£ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/16.jpg)

# æ€»ç»“

æ•´ä¸ªSpring Securityå°±è®²è§£å®Œæ¯•äº†ï¼Œæˆ‘ä»¬å¯¹ä¸¤ä¸ªè¿‡æ»¤å™¨ã€Nå¤šä¸ªç»„ä»¶è¿›è¡Œäº†è‡ªå®šä¹‰å®ç°ï¼Œä»è€Œè¾¾åˆ°äº†æˆ‘ä»¬çš„åŠŸèƒ½ã€‚è¿™é‡Œåšäº†ä¸€ä¸ªæ€ç»´å¯¼å›¾æ–¹ä¾¿å¤§å®¶ç†è§£ï¼š

![image-20230120152730671](4.é¡¹ç›®å®è·µ_ä¸€æ–‡å¸¦ä½ æå®šå‰åç«¯åˆ†ç¦»ä¸‹çš„è®¤è¯å’Œæˆæƒ.assets/17.jpg)

åˆ«çœ‹ç»„ä»¶è¿™ä¹ˆå¤šï¼Œè®¤è¯æˆæƒçš„æ ¸å¿ƒæµç¨‹å’Œä¸€äº›æ¦‚å¿µæ˜¯ä¸ä¼šå˜çš„ï¼Œä»€ä¹ˆå®‰å…¨æ¡†æ¶éƒ½ä¸‡å˜ä¸ç¦»å…¶å®—ã€‚æ¯”å¦‚`Shiro`ï¼Œå…¶ä¸­æœ€åŸºæœ¬çš„æ¦‚å¿µ`Subject`å°±ä»£è¡¨å½“å‰ç”¨æˆ·ï¼Œ`SubjectManager`å°±æ˜¯ç”¨æˆ·ç®¡ç†å™¨â€¦â€¦

åœ¨æˆ‘å‰ä¸¤ç¯‡æ–‡ç« ä¸­æœ‰äººä¹Ÿè°ˆåˆ°ç”¨å®‰å…¨æ¡†æ¶è¿˜ä¸å¦‚è‡ªå·±æ‰‹å†™ï¼Œç¡®å®ï¼Œæ‰‹å†™å¯ä»¥æœ€å¤§çµæ´»åº¦æŒ‰ç…§è‡ªå·±çš„æƒ³æ³•æ¥ï¼ˆå¹¶ä¸”ä¹Ÿä¸å¤æ‚ï¼‰ï¼Œä½¿ç”¨å®‰å…¨æ¡†æ¶åè€Œè¦é…åˆæ¡†æ¶çš„å®šå¼ï¼Œå¥½åƒè¢«æŸç¼šäº†ã€‚é‚£å®‰å…¨æ¡†æ¶å¯¹æ¯”æ‰‹å†™æœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿæˆ‘è§‰å¾—ä¼˜åŠ¿ä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ç‚¹ï¼š

1. ä¸€äº›åŠŸèƒ½å¼€ç®±å³ç”¨ï¼Œæ¯”å¦‚Spring Securityçš„åŠ å¯†å™¨ï¼Œéå¸¸æ–¹ä¾¿
2. æ¡†æ¶çš„å®šå¼æ—¢æ˜¯æŸç¼šä¹Ÿæ˜¯è§„èŒƒï¼Œæ— è®ºè°æ¥æ‰‹ä½ çš„é¡¹ç›®ï¼Œä¸€çœ‹åˆ°ç†Ÿæ‚‰çš„å®‰å…¨æ¡†æ¶å°±èƒ½ç«‹é©¬ä¸Šæ‰‹

è®²è§£åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæœ¬æ–‡æ‰€æœ‰ä»£ç ã€`SQL`è¯­å¥éƒ½æ”¾åœ¨Githubå…‹éš†ä¸‹æ¥å³å¯è¿è¡Œï¼š

https://github.com/RudeCrab/rude-java